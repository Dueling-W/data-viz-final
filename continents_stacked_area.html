<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Stacked CO₂ Emissions by Continent</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  body { font-family: sans-serif; }
  svg { width: 100%; height: 600px; }
  .layer { stroke: none; transition: opacity 0.2s; cursor: pointer; }
  .legend { font-size: 12px; }
  .tooltip {
    position: absolute;
    background: white;
    border: 1px solid #999;
    padding: 6px 10px;
    pointer-events: none;
    font-size: 12px;
    border-radius: 4px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
  }
</style>
</head>
<body>
<svg width="960" height="600"></svg>
<div class="tooltip" style="opacity:0;"></div>

<script>
const continentMap = {
"Afghanistan":"Asia","Albania":"Europe","Algeria":"Africa","American Samoa":"Oceania","Andorra":"Europe","Angola":"Africa",
"Anguilla":"North America","Antarctica":"Antarctica","Antigua and Barbuda":"North America","Argentina":"South America",
"Armenia":"Asia","Aruba":"North America","Australia":"Oceania","Austria":"Europe",
"Azerbaijan":"Asia","Bahamas":"North America","Bahrain":"Asia","Bangladesh":"Asia","Barbados":"North America","Belarus":"Europe","Belgium":"Europe",
"Belize":"North America","Benin":"Africa","Bermuda":"North America","Bhutan":"Asia","Bolivia":"South America","Bosnia and Herzegovina":"Europe","Botswana":"Africa",
"Bouvet Island":"Antarctica","Brazil":"South America","British Indian Ocean Territory":"Africa","Brunei":"Asia","Bulgaria":"Europe","Burkina Faso":"Africa","Burundi":"Africa",
"Cambodia":"Asia","Cameroon":"Africa","Canada":"North America","Cape Verde":"Africa","Cayman Islands":"North America","Central African Republic":"Africa","Chad":"Africa",
"Chile":"South America","China":"Asia","Christmas Island":"Oceania","Cocos (Keeling) Islands":"Oceania","Colombia":"South America","Comoros":"Africa","Congo":"Africa",
"Cook Islands":"Oceania","Costa Rica":"North America","Croatia":"Europe","Cuba":"North America","Cyprus":"Asia","Czech Republic":"Europe","Denmark":"Europe","Djibouti":"Africa",
"Dominica":"North America","Dominican Republic":"North America","East Timor":"Asia","Ecuador":"South America","Egypt":"Africa","El Salvador":"North America","England":"Europe",
"Equatorial Guinea":"Africa","Eritrea":"Africa","Estonia":"Europe","Ethiopia":"Africa","Falkland Islands":"South America","Faroe Islands":"Europe",
"Fiji Islands":"Oceania","Finland":"Europe","France":"Europe","French Guiana":"South America","French Polynesia":"Oceania","French Southern territories":"Antarctica",
"Gabon":"Africa","Gambia":"Africa","Georgia":"Asia","Germany":"Europe","Ghana":"Africa","Gibraltar":"Europe","Greece":"Europe","Greenland":"North America","Grenada":"North America",
"Guadeloupe":"North America","Guam":"Oceania","Guatemala":"North America","Guinea":"Africa","Guinea-Bissau":"Africa","Guyana":"South America","Haiti":"North America",
"Heard Island and McDonald Islands":"Antarctica","Holy See (Vatican City State)":"Europe","Honduras":"North America","Hong Kong":"Asia",
"Hungary":"Europe","Iceland":"Europe","India":"Asia","Indonesia":"Asia","Iran":"Asia","Iraq":"Asia","Ireland":"Europe",
"Israel":"Asia","Italy":"Europe","Ivory Coast":"Africa","Jamaica":"North America","Japan":"Asia","Jordan":"Asia","Kazakhstan":"Asia","Kenya":"Africa","Kiribati":"Oceania",
"Kuwait":"Asia","Kyrgyzstan":"Asia","Laos":"Asia","Latvia":"Europe","Lebanon":"Asia","Lesotho":"Africa","Liberia":"Africa","Libyan Arab Jamahiriya":"Africa","Liechtenstein":"Europe",
"Lithuania":"Europe","Luxembourg":"Europe","Macao":"Asia","North Macedonia":"Europe","Madagascar":"Africa","Malawi":"Africa","Malaysia":"Asia","Maldives":"Asia","Mali":"Africa",
"Malta":"Europe","Marshall Islands":"Oceania","Martinique":"North America","Mauritania":"Africa","Mauritius":"Africa","Mayotte":"Africa","Mexico":"North America",
"Micronesia, Federated States of":"Oceania","Moldova":"Europe","Monaco":"Europe","Mongolia":"Asia","Montenegro":"Europe","Montserrat":"North America","Morocco":"Africa","Mozambique":"Africa",
"Myanmar":"Asia","Namibia":"Africa","Nauru":"Oceania","Nepal":"Asia","Netherlands":"Europe","Netherlands Antilles":"North America","New Caledonia":"Oceania","New Zealand":"Oceania",
"Nicaragua":"North America","Niger":"Africa","Nigeria":"Africa","Niue":"Oceania","Norfolk Island":"Oceania","North Korea":"Asia","Northern Ireland":"Europe",
"Northern Mariana Islands":"Oceania","Norway":"Europe","Oman":"Asia","Pakistan":"Asia","Palau":"Oceania","Palestine":"Asia","Panama":"North America","Papua New Guinea":"Oceania",
"Paraguay":"South America","Peru":"South America","Philippines":"Asia","Pitcairn":"Oceania","Poland":"Europe","Portugal":"Europe","Puerto Rico":"North America","Qatar":"Asia",
"Reunion":"Africa","Romania":"Europe","Russian Federation":"Europe","Rwanda":"Africa","Saint Helena":"Africa","Saint Kitts and Nevis":"North America","Saint Lucia":"North America",
"Saint Pierre and Miquelon":"North America","Saint Vincent and the Grenadines":"North America","Samoa":"Oceania","San Marino":"Europe","Sao Tome and Principe":"Africa","Saudi Arabia":"Asia",
"Scotland":"Europe","Senegal":"Africa","Serbia":"Europe","Seychelles":"Africa","Sierra Leone":"Africa","Singapore":"Asia","Slovakia":"Europe","Slovenia":"Europe","Solomon Islands":"Oceania",
"Somalia":"Africa","South Africa":"Africa","South Georgia and the South Sandwich Islands":"Antarctica","South Korea":"Asia","South Sudan":"Africa","Spain":"Europe","Sri Lanka":"Asia",
"Sudan":"Africa","Suriname":"South America","Svalbard and Jan Mayen":"Europe","Swaziland":"Africa","Sweden":"Europe","Switzerland":"Europe","Syria":"Asia",
"Tajikistan":"Asia","Tanzania":"Africa","Thailand":"Asia","The Democratic Republic of Congo":"Africa","Togo":"Africa","Tokelau":"Oceania","Tonga":"Oceania",
"Trinidad and Tobago":"North America","Tunisia":"Africa","Turkey":"Asia","Turkmenistan":"Asia","Turks and Caicos Islands":"North America","Tuvalu":"Oceania","Uganda":"Africa","Ukraine":"Europe",
"United Arab Emirates":"Asia","United Kingdom":"Europe","United States":"North America","United States Minor Outlying Islands":"Oceania","Uruguay":"South America","Uzbekistan":"Asia",
"Vanuatu":"Oceania","Venezuela":"South America","Vietnam":"Asia","Virgin Islands, British":"North America","Virgin Islands, U.S.":"North America","Wales":"Europe",
"Wallis and Futuna":"Oceania","Western Sahara":"Africa","Yemen":"Asia","Zambia":"Africa","Zimbabwe":"Africa"
};

const svg = d3.select("svg"),
      margin = {top: 50, right: 150, bottom: 50, left: 80},
      width = +svg.attr("width") - margin.left - margin.right,
      height = +svg.attr("height") - margin.top - margin.bottom;

const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
const tooltip = d3.select(".tooltip");

d3.csv("data/total_co2_data.csv").then(data => {
  const years = data.columns.slice(4);

  const continentData = {};
  data.forEach(d => {
    const continent = continentMap[d["Country Name"]];
    if (!continent) return;
    if (!continentData[continent]) continentData[continent] = {};
    years.forEach(y => {
      const val = parseFloat(d[y]);
      if (!isNaN(val)) {  // only sum valid numbers
        continentData[continent][y] = (continentData[continent][y] || 0) + val;
      }
    });
  });

  // Convert to array for stacking
  const stackedArray = years.map(y => {
    const row = { Year: +y };
    Object.keys(continentData).forEach(c => {
      const val = continentData[c][y];
      if (val !== undefined) row[c] = val;  // only assign if value exists
    });
    return row;
  }).filter(d => Object.keys(d).length > 1); // remove rows with no valid data

  const continents = Object.keys(continentData);
  const stack = d3.stack().keys(continents);
  const series = stack(stackedArray);

  const x = d3.scaleLinear()
              .domain(d3.extent(stackedArray, d => d.Year))
              .range([0, width]);

  const y = d3.scaleLinear()
              .domain([0, d3.max(series, s => d3.max(s, d => d[1]))])
              .range([height, 0]);

  const color = d3.scaleOrdinal(d3.schemeCategory10).domain(continents);

  const area = d3.area()
                 .x(d => x(d.data.Year))
                 .y0(d => y(d[0]))
                 .y1(d => y(d[1]));

  const layers = g.selectAll(".layer")
    .data(series)
    .join("path")
      .attr("class", "layer")
      .attr("d", area)
      .attr("fill", d => color(d.key))
      .on("mouseover", function(event, d) {
        layers.attr("opacity", 0.2);
        d3.select(this).attr("opacity", 1).raise();
        tooltip.style("opacity", 1);
      })
      .on("mousemove", function(event, d) {
        const xm = d3.pointer(event, this)[0];
        const year = Math.round(x.invert(xm));
        const row = stackedArray.find(r => r.Year === year);
        if (row && row[d.key] !== undefined) {
          tooltip.style("left", (event.pageX + 10) + "px")
                 .style("top", (event.pageY - 25) + "px")
                 .html(`<strong>${d.key}</strong><br>Year: ${year}<br>CO₂: ${row[d.key].toFixed(2)} Mt`);
        }
      })
      .on("mouseout", function() {
        layers.attr("opacity", 1);
        tooltip.style("opacity", 0);
      });

  // Axes
  g.append("g")
   .attr("transform", `translate(0,${height})`)
   .call(d3.axisBottom(x).tickFormat(d3.format("d")));

  g.append("g")
   .call(d3.axisLeft(y));

  // Legend
  const legend = svg.append("g")
                    .attr("transform", `translate(${width + margin.left + 20},${margin.top})`);
  continents.forEach((c,i) => {
    const gLegend = legend.append("g").attr("transform", `translate(0,${i*20})`);
    gLegend.append("rect").attr("width",15).attr("height",15).attr("fill", color(c));
    gLegend.append("text").attr("x",20).attr("y",12).text(c);
  });
});
</script>
</body>
</html>
